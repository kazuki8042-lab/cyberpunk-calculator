
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Neon 55 Calculator</title>
 <!-- ===== アイコン / モバイル設定 ===== -->
  <link rel="apple-touch-icon" sizes="180x180" href="./Cyberpunk Calculator.png">
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16.png">
  <meta name="theme-color" content="#0b0d10">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Cyberpunk Calculator.png">
  <!-- ================================ -->
  <style>
    :root{
      --bg:#050510;
      --panel:#0b0b1a;
      --neon-cyan:#00f5ff;
      --neon-pink:#ff2bd6;
      --neon-purple:#7a2cff;
      --text:#e8f0ff;
      --muted:rgba(232,240,255,0.65);

      /* 見た目は小さめ、でもタップ領域は確保 */
      --btn-visual-size: clamp(52px, 12vw, 74px);
      --btn-tap-size: clamp(56px, 14vw, 82px);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      background: radial-gradient(1200px 700px at 30% 10%, rgba(122,44,255,0.18), transparent 55%),
                  radial-gradient(900px 600px at 80% 30%, rgba(0,245,255,0.14), transparent 55%),
                  var(--bg);
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .app{
      min-height: 100dvh;
      display:flex;
      flex-direction:column;
      /* 下が欠けやすい環境向けに“余裕”を追加 */
      padding: 16px 16px max(24px, calc(env(safe-area-inset-bottom) + 24px));
      gap: 12px;
    }

    header, footer{
      color: var(--muted);
      font-size: 0.8rem;
      line-height: 1.3;
    }
    header .title{
      color: var(--text);
      font-weight: 700;
      letter-spacing: 0.02em;
      font-size: 1.2rem;
      font-family: "Orbitron", "Oxanium", "Rajdhani", "SF Pro Display", "Segoe UI", sans-serif;
      display:flex;
      align-items:baseline;
      gap:.6rem;
    }

    main{
      /* app自体が100dvhなので、ここで100dvhを重ねると下が押し出されやすい */
      display:flex;
      flex-direction:column;
      gap: 12px;
      flex: 1;
    }

    /* 履歴（5行固定） */
    .history{
      background: rgba(11,11,26,0.50);
      border: 1px solid rgba(0,245,255,0.14);
      border-radius: var(--radius);
      padding: 8px 12px;
      box-shadow:
        0 0 0 1px rgba(255,43,214,0.05) inset,
        0 0 16px rgba(0,245,255,0.06);
      position:relative;
      overflow:hidden;
    }
    .history::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        linear-gradient(transparent 0, rgba(0,245,255,0.05) 1px, transparent 2px) 0 0/100% 10px,
        radial-gradient(circle at 20% 30%, rgba(255,43,214,0.08), transparent 45%),
        radial-gradient(circle at 80% 70%, rgba(0,245,255,0.06), transparent 45%);
      pointer-events:none;
      mix-blend-mode: screen;
      opacity: .9;
    }
    .history ol{
      margin:0;
      padding:0;
      list-style:none;
      font-size: 0.72rem;
      line-height: 1.2;
      min-height: calc(1.2em * 5);
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      gap: 0.06rem;
      position:relative;
      z-index:1;
    }
    .history li{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      color: rgba(232,240,255,0.78);
    }
    .history li.empty{
      color: rgba(232,240,255,0.18);
    }

    /* ディスプレイ */
    .display{
      background: rgba(11,11,26,0.8);
      border: 1px solid rgba(255,43,214,0.20);
      border-radius: calc(var(--radius) + 4px);
      padding: 12px 16px;
      box-shadow:
        0 0 0 1px rgba(0,245,255,0.10) inset,
        0 0 28px rgba(122,44,255,0.12),
        0 0 18px rgba(255,43,214,0.10);
      position:relative;
      overflow:hidden;

      /* レイアウトを安定させつつ、キー入力エリアを優先してスペースを譲る */
      flex: 0 0 auto;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .display.flash-55{
      box-shadow:
        0 0 0 1px rgba(0,245,255,0.14) inset,
        0 0 32px rgba(0,245,255,0.16),
        0 0 22px rgba(255,43,214,0.10);
    }
    .display.flash-eq{
      box-shadow:
        0 0 0 1px rgba(122,44,255,0.18) inset,
        0 0 38px rgba(122,44,255,0.20),
        0 0 18px rgba(0,245,255,0.10);
    }
    .display.flash-error{
      box-shadow:
        0 0 0 1px rgba(255,43,214,0.18) inset,
        0 0 40px rgba(255,43,214,0.16);
    }
    .display::after{
      content:"";
      position:absolute;
      inset:-40px -40px auto -40px;
      height:120px;
      background: linear-gradient(90deg, transparent, rgba(0,245,255,0.09), transparent);
      transform: rotate(-8deg);
      pointer-events:none;
      opacity:.8;
    }
    .expression{
      flex: 0 0 auto;
      font-size: 0.95rem;
      color: rgba(232,240,255,0.72);
      min-height: 1.2em;
      letter-spacing: 0.02em;
      word-break: break-all;
    }
    .note-field{
      width: 100%;
      min-height: 52px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,245,255,0.16);
      background: rgba(5,8,20,0.55);
      color: rgba(232,240,255,0.9);
      font-size: 0.95rem;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      resize: none;
      outline: none;
      box-shadow: 0 0 0 1px rgba(0,245,255,0.06) inset;
    }
    .note-field::placeholder{
      color: rgba(232,240,255,0.38);
    }
    .note-field:focus{
      border-color: rgba(0,245,255,0.32);
      box-shadow:
        0 0 0 1px rgba(0,245,255,0.12) inset,
        0 0 18px rgba(0,245,255,0.10);
    }
    .value{
      /* 結果を少し上に持ち上げて、下のキーエリアに余裕を作る */
      margin-top: 10px;
      padding-top: 4px;
      font-size: clamp(2.0rem, 6.2vw, 3.0rem);
      font-weight: 800;
      letter-spacing: 0.02em;
      text-align:right;
      text-shadow: 0 0 16px rgba(0,245,255,0.14);
      word-break: break-all;
    }
    .value.error{
      color: rgba(255,43,214,0.95);
      text-shadow: 0 0 18px rgba(255,43,214,0.22);
    }

    /* ボタンエリア（下寄せ） */
    .pad{
      margin-top: auto;
      /* キーの下端が白く欠けるのを防ぐ（セーフエリア＋余白） */
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
      background: rgba(11,11,26,0.82);
      border: 1px solid rgba(122,44,255,0.18);
      border-radius: calc(var(--radius) + 8px);
      padding: 14px;
      box-shadow:
        0 0 0 1px rgba(0,245,255,0.08) inset,
        0 0 28px rgba(0,245,255,0.07);
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      align-items:stretch;
      grid-auto-rows: var(--btn-tap-size);
    }

    button.key{
      appearance:none;
      border:none;
      background: transparent;
      padding: 0;
      margin:0;
      height: var(--btn-tap-size);
      min-width: var(--btn-tap-size);
      border-radius: 16px;
      position:relative;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    /* 見た目の小さい“コア” */
    button.key .core{
      position: relative;
      width: var(--btn-visual-size);
      height: var(--btn-visual-size);
      border-radius: 999px;
      margin:auto;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 800;
      font-size: clamp(1.15rem, 4.2vw, 1.6rem);
      letter-spacing: 0.02em;
      user-select:none;

      background: rgba(232,240,255,0.04);
      border: 1px solid rgba(232,240,255,0.10);
      box-shadow:
        0 0 0 1px rgba(0,245,255,0.08) inset,
        0 0 16px rgba(0,245,255,0.08);
      color: rgba(232,240,255,0.95);
    }

    button.key .core .label{
      line-height: 1;
    }
    button.key .core .sublabel{
      position: absolute;
      bottom: -12px;
      font-size: .62rem;
      color: rgba(232,240,255,0.55);
      letter-spacing: 0.02em;
      pointer-events:none;
      display:none;
    }
    button.key[data-action="fiftyfive"] .core .sublabel{ display:block; }

    button.key.op .core{
      border-color: rgba(0,245,255,0.22);
      box-shadow:
        0 0 0 1px rgba(0,245,255,0.12) inset,
        0 0 18px rgba(0,245,255,0.12);
      color: rgba(0,245,255,0.95);
      text-shadow: 0 0 10px rgba(0,245,255,0.18);
    }
    button.key.accent .core{
      border-color: rgba(255,43,214,0.30);
      box-shadow:
        0 0 0 1px rgba(255,43,214,0.12) inset,
        0 0 18px rgba(255,43,214,0.16);
      color: rgba(255,43,214,0.98);
      text-shadow: 0 0 12px rgba(255,43,214,0.22);
    }
    button.key.equals .core{
      width: calc(var(--btn-visual-size) + 10px);
      height: calc(var(--btn-visual-size) + 10px);
      border-color: rgba(122,44,255,0.40);
      box-shadow:
        0 0 0 1px rgba(122,44,255,0.16) inset,
        0 0 20px rgba(122,44,255,0.18);
      color: rgba(232,240,255,0.98);
      background: rgba(122,44,255,0.10);
    }

    button.key:active .core{
      transform: scale(0.96);
      box-shadow:
        0 0 0 1px rgba(0,245,255,0.18) inset,
        0 0 26px rgba(0,245,255,0.18);
    }
    button.key.accent:active .core{
      box-shadow:
        0 0 0 1px rgba(255,43,214,0.18) inset,
        0 0 28px rgba(255,43,214,0.22);
    }
    button.key.equals:active .core{
      box-shadow:
        0 0 0 1px rgba(122,44,255,0.22) inset,
        0 0 30px rgba(122,44,255,0.25);
    }

    /* = を縦2マス */
    .span2{
      grid-row: span 2;
    }
    /* 0 を横2マス */
    .wide{
      grid-column: span 2;
    }

    footer{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      align-items:flex-end;
      padding-top: 2px;
    }
    footer small{ opacity:.9; }

    /* PC hover */
    @media (hover:hover){
      button.key:hover .core{
        box-shadow:
          0 0 0 1px rgba(0,245,255,0.14) inset,
          0 0 22px rgba(0,245,255,0.14);
      }
      button.key.accent:hover .core{
        box-shadow:
          0 0 0 1px rgba(255,43,214,0.16) inset,
          0 0 24px rgba(255,43,214,0.18);
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">
        <span>Neon 55 Calculator</span>
      </div>
    </header>

    <main>
      <section class="history" aria-label="計算履歴（直近5件）">
        <ol id="historyList"></ol>
      </section>

      <section class="display" aria-label="表示エリア">
        <div class="expression" id="expressionLine" aria-label="式表示"></div>
        <textarea class="note-field" id="noteInput" rows="2" placeholder="メモ（自由記述）" aria-label="メモ入力"></textarea>
        <div class="value" id="valueLine" aria-label="結果表示">0</div>
      </section>

      <section class="pad" aria-label="ボタンエリア">
        <div class="grid" id="keys">
          <!-- 1行目 -->
          <button class="key accent" data-action="clear" aria-label="クリア">
            <span class="core">C</span>
          </button>
          <button class="key accent" data-action="fiftyfive" aria-label="55（0.55倍）">
            <span class="core"><span class="label">55</span><span class="sublabel">×0.55</span></span>
          </button>
          <button class="key op" data-op="/" aria-label="割り算">
            <span class="core">÷</span>
          </button>
          <button class="key op" data-op="*" aria-label="掛け算">
            <span class="core">×</span>
          </button>

          <!-- 2行目 -->
          <button class="key" data-digit="7" aria-label="7">
            <span class="core">7</span>
          </button>
          <button class="key" data-digit="8" aria-label="8">
            <span class="core">8</span>
          </button>
          <button class="key" data-digit="9" aria-label="9">
            <span class="core">9</span>
          </button>
          <button class="key op" data-op="-" aria-label="マイナス">
            <span class="core">−</span>
          </button>

          <!-- 3行目 -->
          <button class="key" data-digit="4" aria-label="4">
            <span class="core">4</span>
          </button>
          <button class="key" data-digit="5" aria-label="5">
            <span class="core">5</span>
          </button>
          <button class="key" data-digit="6" aria-label="6">
            <span class="core">6</span>
          </button>
          <button class="key op" data-op="+" aria-label="プラス">
            <span class="core">+</span>
          </button>

          <!-- 4行目 -->
          <button class="key" data-digit="1" aria-label="1">
            <span class="core">1</span>
          </button>
          <button class="key" data-digit="2" aria-label="2">
            <span class="core">2</span>
          </button>
          <button class="key" data-digit="3" aria-label="3">
            <span class="core">3</span>
          </button>
          <button class="key equals span2" data-action="equals" aria-label="イコール">
            <span class="core">=</span>
          </button>

          <!-- 5行目 -->
          <button class="key wide" data-digit="0" aria-label="0">
            <span class="core">0</span>
          </button>
          <button class="key" data-action="dot" aria-label="小数点">
            <span class="core">.</span>
          </button>
        </div>
      </section>
    </main>

    <footer>
      <small>※ eval不使用 / 四則のみ / 0除算はError</small>
      <small>v1.0</small>
    </footer>
  </div>

  <script>
    // ----- State -----
    const state = {
      currentInput: "0",
      expression: "",
      previewExpression: "",
      pendingHistoryExpression: "",
      history: [], // max 5
      lastResult: null, // "="後の結果（文字列）
      justEvaluated: false,
      error: false,
      note: ""
    };

    // ----- Elements -----
    const elHistory = document.getElementById("historyList");
    const elExpr = document.getElementById("expressionLine");
    const elVal = document.getElementById("valueLine");
    const elKeys = document.getElementById("keys");
    const elDisplay = document.querySelector(".display");
    const elNote = document.getElementById("noteInput");

    // ----- Utils -----
    function isOperator(ch) {
      return ch === "+" || ch === "-" || ch === "*" || ch === "/";
    }

    function formatNumber(n) {
      if (!Number.isFinite(n)) return "Error";
      // 小数誤差対策：最大10桁で丸め → 末尾0トリム
      const s = n.toFixed(10).replace(/\.?0+$/, "");
      // -0 対策
      return (s === "-0") ? "0" : s;
    }

    function flashDisplay(className, ms = 220) {
      if (!elDisplay) return;
      elDisplay.classList.add(className);
      window.setTimeout(() => elDisplay.classList.remove(className), ms);
    }

    function setError() {
      state.previewExpression = "";
      state.pendingHistoryExpression = "";
      state.error = true;
      state.currentInput = "0";
      state.expression = "";
      state.justEvaluated = false;
      flashDisplay("flash-error");
    }

    // ----- Parser / Evaluator (四則のみ、優先順位あり) -----
    function tokenize(expr) {
      // 許可: 数字, ., + - * /, 空白
      if (!/^[0-9+\-*/.\s]+$/.test(expr)) return null;

      const tokens = [];
      let num = "";

      for (let i = 0; i < expr.length; i++) {
        const c = expr[i];

        if (c === " " || c === "\t" || c === "\n") continue;

        if ((c >= "0" && c <= "9") || c === ".") {
          num += c;
          continue;
        }

        if (isOperator(c)) {
          if (num !== "") {
            if (!isValidNumberToken(num)) return null;
            tokens.push(num);
            num = "";
          }
          tokens.push(c);
          continue;
        }

        return null;
      }

      if (num !== "") {
        if (!isValidNumberToken(num)) return null;
        tokens.push(num);
      }

      return tokens;
    }

    function isValidNumberToken(s) {
      // ".5" を許可しない仕様（要件の例に合わせて入力段階で弾く想定）
      // ここでも厳密に弾く
      if (s.startsWith(".")) return false;
      // "1..2" などはNG
      if ((s.match(/\./g) || []).length > 1) return false;
      // "." 単体もNG
      if (s === ".") return false;
      // Number変換できること
      return Number.isFinite(Number(s));
    }

    function evaluateTokens(tokens) {
      // 不正式（先頭/末尾が演算子、演算子連続）を弾く
      if (!tokens || tokens.length === 0) return { ok: false };
      if (isOperator(tokens[0]) || isOperator(tokens[tokens.length - 1])) return { ok: false };

      for (let i = 0; i < tokens.length - 1; i++) {
        if (isOperator(tokens[i]) && isOperator(tokens[i + 1])) return { ok: false };
      }

      // 1) * / を先に畳む
      const pass1 = [];
      let i = 0;
      while (i < tokens.length) {
        const t = tokens[i];
        if (t === "*" || t === "/") {
          // ここに来るなら直前に数があるはず
          const left = Number(pass1.pop());
          const right = Number(tokens[i + 1]);
          if (!Number.isFinite(left) || !Number.isFinite(right)) return { ok: false };

          if (t === "/" && right === 0) return { ok: false, div0: true };

          const val = (t === "*") ? (left * right) : (left / right);
          pass1.push(String(val));
          i += 2;
        } else {
          pass1.push(t);
          i += 1;
        }
      }

      // 2) + - を左から
      let acc = Number(pass1[0]);
      if (!Number.isFinite(acc)) return { ok: false };

      for (let j = 1; j < pass1.length; j += 2) {
        const op = pass1[j];
        const rhs = Number(pass1[j + 1]);
        if (!Number.isFinite(rhs) || !isOperator(op)) return { ok: false };
        acc = (op === "+") ? (acc + rhs) : (acc - rhs);
      }

      if (!Number.isFinite(acc)) return { ok: false };
      return { ok: true, value: acc };
    }

    // ----- Actions -----
    function inputDigit(d) {
      if (state.error) state.error = false;
      state.previewExpression = "";
      state.pendingHistoryExpression = "";

      // "="直後に数字入力 → 新規入力として開始
      if (state.justEvaluated && state.expression === "") {
        state.currentInput = d;
        state.justEvaluated = false;
        render();
        return;
      }

      if (state.currentInput === "" || state.currentInput == null) {
        state.currentInput = d;
      } else if (state.currentInput === "0") {
        state.currentInput = d; // 先頭ゼロ抑制
      } else {
        state.currentInput += d;
      }
      state.justEvaluated = false;
      render();
    }

    function inputDot() {
      if (state.error) state.error = false;
      state.previewExpression = "";
      state.pendingHistoryExpression = "";

      // "="直後に "." は "0." から開始
      if (state.justEvaluated && state.expression === "") {
        state.currentInput = "0.";
        state.justEvaluated = false;
        render();
        return;
      }

      if (state.currentInput === "" || state.currentInput == null) {
        state.currentInput = "0.";
      } else if (!state.currentInput.includes(".")) {
        state.currentInput += ".";
      }
      state.justEvaluated = false;
      render();
    }

    function inputOperator(op) {
      if (state.error) return;
      state.previewExpression = "";
      state.pendingHistoryExpression = "";

      const hasInput = state.currentInput !== "" && state.currentInput != null;
      const hasExpr = state.expression !== "";

      // expression が空で currentInput がある → expression = currentInput + op
      if (!hasExpr && hasInput) {
        state.expression = state.currentInput + " " + op + " ";
        state.currentInput = "";
        state.justEvaluated = false;
        render();
        return;
      }

      // expression があり、末尾が演算子 → 置換
      if (hasExpr && state.expression.trim().length > 0) {
        const trimmed = state.expression.trimEnd();
        const lastChar = trimmed[trimmed.length - 1];
        if (isOperator(lastChar)) {
          state.expression = trimmed.slice(0, -1) + op + " ";
          state.justEvaluated = false;
          render();
          return;
        }
      }

      // expression があり、currentInput もある → expression += currentInput + op
      if (hasExpr && hasInput) {
        state.expression += state.currentInput + " " + op + " ";
        state.currentInput = "";
        state.justEvaluated = false;
        render();
        return;
      }

      // それ以外（入力なしで演算子だけ等）は無視
    }

    function clearAll() {
      state.currentInput = "0";
      state.previewExpression = "";
      state.pendingHistoryExpression = "";
      state.expression = "";
      state.error = false;
      state.justEvaluated = false;
      state.note = "";
      // 履歴は消さない（仕様）
      render();
    }

    function apply55() {
      if (state.error) state.error = false;

      // 55適用時は「元の値 × 0.55」を上段に表示
      //（履歴には入れない。=確定時のみ履歴追加）

      let targetStr = null;

      if (state.currentInput !== "" && state.currentInput != null) {
        targetStr = state.currentInput;
      } else if (state.lastResult != null) {
        targetStr = state.lastResult;
      } else {
        targetStr = "0";
      }

      const n = Number(targetStr);
      if (!Number.isFinite(n)) {
        setError();
        render();
        return;
      }
      const original = formatNumber(n);
      const newVal = n * 0.55;
      // 上段に見える式（表示用なので × 記号）
      state.previewExpression = `${original} × 0.55`;
      state.pendingHistoryExpression = state.previewExpression;
      flashDisplay("flash-55");
      const formatted = formatNumber(newVal);
      if (formatted === "Error") {
        setError();
      } else {
        state.currentInput = formatted;
        state.justEvaluated = false;
      }
      // 履歴には入れない（=確定時のみ）
      render();
    }

    function equals() {
      if (state.error) return;

      // 55を押した直後の「=」は履歴に元の式を残したい
      const pendingHistory = state.pendingHistoryExpression;
      state.previewExpression = "";
      state.pendingHistoryExpression = "";

      const exprPart = state.expression.trim();
      const inputPart = (state.currentInput !== "" && state.currentInput != null) ? state.currentInput : "";

      const fullExpression = (exprPart + (inputPart ? (" " + inputPart) : "")).trim();

      // 空・不正はError
      const tokens = tokenize(fullExpression);
      const result = evaluateTokens(tokens);

      if (!fullExpression || !result.ok) {
        setError();
        render();
        return;
      }

      const out = formatNumber(result.value);
      if (out === "Error") {
        setError();
        render();
        return;
      }

      // 表示更新
      state.lastResult = out;
      state.currentInput = out;
      state.expression = ""; // 結果から続けて演算しやすい設計
      state.justEvaluated = true;
      state.error = false;

      // 履歴 push（最大5件・最新が一番下）
      const noteText = state.note.trim();
      const noteSuffix = noteText ? ` (${noteText})` : "";
      const historyLine = (pendingHistory && state.expression.trim() === "")
        ? `${pendingHistory} = ${out}${noteSuffix}`
        : (fullExpression.replace(/\s+/g, " ") + " = " + out + noteSuffix);
      state.history.push(historyLine);
      if (state.history.length > 5) state.history.shift();
      state.note = "";

      flashDisplay("flash-eq");

      render();
    }

    // ----- Render -----
    function render() {
      // 履歴（5行固定：古→新。最新は一番下）
      const lines = state.history.slice(-5);
      const padded = Array(Math.max(0, 5 - lines.length)).fill("").concat(lines);

      elHistory.innerHTML = "";
      for (const line of padded) {
        const li = document.createElement("li");
        if (!line) {
          li.className = "empty";
          li.innerHTML = "&nbsp;";
        } else {
          li.textContent = line;
        }
        elHistory.appendChild(li);
      }

      // 上段：式（今作ってる途中の expression + currentInput を“それっぽく”表示）
      const exprPreview = (() => {
        if (state.previewExpression) return state.previewExpression;
        const a = state.expression.trim();
        const b = (state.currentInput !== "" && state.currentInput != null) ? state.currentInput : "";
        if (!a && !b) return "";
        if (a && b) return (a + " " + b).replace(/\s+/g, " ");
        return (a || b).replace(/\s+/g, " ");
      })();

      elExpr.textContent = exprPreview;

      // 下段：現在値/結果
      if (state.error) {
        elVal.textContent = "Error";
        elVal.classList.add("error");
      } else {
        const shown = (state.currentInput !== "" && state.currentInput != null) ? state.currentInput : "0";
        elVal.textContent = shown;
        elVal.classList.remove("error");
      }

      if (elNote && document.activeElement !== elNote) {
        elNote.value = state.note;
      }
    }

    if (elNote) {
      elNote.addEventListener("input", () => {
        state.note = elNote.value;
      });
    }

    // ----- Events -----
    elKeys.addEventListener("click", (e) => {
      const btn = e.target.closest("button.key");
      if (!btn) return;

      const digit = btn.getAttribute("data-digit");
      const op = btn.getAttribute("data-op");
      const action = btn.getAttribute("data-action");

      if (digit != null) return inputDigit(digit);
      if (op != null) return inputOperator(op);

      if (action === "clear") return clearAll();
      if (action === "dot") return inputDot();
      if (action === "equals") return equals();
      if (action === "fiftyfive") return apply55();
    });

    // キーボード操作（任意：追加仕様）
    document.addEventListener("keydown", (e) => {
      const k = e.key;
      if (k >= "0" && k <= "9") { e.preventDefault(); inputDigit(k); return; }
      if (k === ".") { e.preventDefault(); inputDot(); return; }
      if (k === "+" || k === "-" || k === "*" || k === "/") { e.preventDefault(); inputOperator(k); return; }
      if (k === "Enter" || k === "=") { e.preventDefault(); equals(); return; }
      if (k === "Escape") { e.preventDefault(); clearAll(); return; }
      // Backspaceは要件外なので未実装（必要なら追加可能）
    });

    // init
    render();
  </script>
</body>
</html>
